unsetopt PROMPT_SP

# Performance optimizations
DISABLE_AUTO_UPDATE="true"
DISABLE_MAGIC_FUNCTIONS="true"
DISABLE_COMPFIX="true"

# Cache completions aggressively
autoload -Uz compinit
if [ "$(date +'%j')" != "$(stat -f '%Sm' -t '%j' ~/.zcompdump 2>/dev/null)" ]; then
  compinit
else
  compinit -C
fi

PROMPT='%{$fg[green]%}%n@%m:%{$fg_bold[blue]%}%2~ $(git_prompt_info)%{$reset_color%}%(!.#.$) '
PROMPT='%{$fg[green]%}%n(%m) %{$fg_bold[blue]%}%2~ $(git_prompt_info)%{$fg[magenta]%}%(!.#.→)%{$reset_color%} '
ZSH_THEME_GIT_PROMPT_PREFIX="%{$fg[red]%}‹"
ZSH_THEME_GIT_PROMPT_SUFFIX="›%{$reset_color%}"

source "$HOME/.oh-my-zsh/oh-my-zsh.sh"

alias open=xdg-open
alias zsh-reload="source ~/.zshrc"
alias vi="hx"
alias vim="hx"
alias nano="hx"
alias shx="sudo hx"

# DNF shortcuts
alias dnfup="sudo dnf update -y"
alias dnfadd="sudo dnf -y install"
alias dnfdel="sudo dnf -y remove"

# Nix shortcuts
alias nixadd="nix profile add"
alias nixdel="nix profile remove"

# Flatpak shortcuts
alias flatadd='flatpak install -y flathub'
alias flatdel='flatpak remove -y'

alias compose="docker compose"
alias l="eza -la"
alias ls="eza -la"

alias sup='sudo -E'
alias gl='git pull'
alias gp='git push'
alias gpo='git push -u origin'
alias gs='git status'
alias gb='git branch'
alias gco='git checkout'
alias gcb='git checkout -b'
alias gd='git diff'
alias ga='git add'
alias gall='git add .'
alias gc='git commit'
alias gcm='git commit -m'
alias gcan='git commit --amend --no-edit'
alias git-confia="git add . && git commit --amend --no-edit && git push --force"
alias git-curr-branch='git rev-parse --abbrev-ref HEAD'
alias git-push='git push -u origin $(git-curr-branch)'

export TERM=xterm
export VISUAL=hx
export EDITOR="$VISUAL"
export ELECTRON_OZONE_PLATFORM_HINT=wayland
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

export PATH="$HOME/Scripts/:$PATH"
export PATH="$HOME/.visualglitch91/scripts/:$PATH"
export PATH="$HOME/.local/bin/:$PATH"
export PATH="$HOME/.cargo/bin:$PATH"
export PATH="$HOME/.bun/bin:$PATH"
export PATH="$HOME/.nix-profile/bin:$PATH"
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"

eval "$(starship init zsh)"

function current_dir() {
  local dir=$PWD
  if [[ $dir == "$HOME" ]]; then
    echo "~"
  else
    echo "${dir##*/}"
  fi
}

function change_tab_title() {
  local title=$1
  tmux rename-window -- "$title"
}

function set_tab_to_working_dir() {
  local result=$?
  local title
  title=$(current_dir)
  change_tab_title "$title"
}

function set_tab_to_command_line() {
  local cmdline=$1
  change_tab_title "$cmdline"
}

if [[ -n $TMUX ]]; then
  add-zsh-hook precmd set_tab_to_working_dir
  add-zsh-hook preexec set_tab_to_command_line
fi

if [[ $- =~ i ]] && [[ -z "$TMUX" ]] && [[ -n "$SSH_TTY" ]]; then
  tmux set -g default-shell $SHELL
  tmux attach-session -t ssh_tmux || tmux new-session -s ssh_tmux
  exit
fi
