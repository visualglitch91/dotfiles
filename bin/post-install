#!/usr/bin/env bash

source "$HOME/.visualglitch91/env"

symlink() {
    local source="$1"
    local destination="$2"

    # Get the absolute path of the source
    target=$(realpath "$ROOT/$source")

    # If the destination is relative, prepend $HOME
    if [[ "$destination" == /* ]]; then
        link_name="$destination"
    else
        link_name="$HOME/$destination"
    fi

    echo "Creating symlink: $link_name -> $target"

    # Remove directory
    rm -rf "$link_name"

    # Create the symlink
    ln -s "$target" "$link_name"
}

sudo flatpak override --filesystem=$HOME/.themes
sudo flatpak override --filesystem=$HOME/.icons
sudo flatpak override --filesystem=xdg-config/gtk-4.0
flatpak override --user --filesystem=xdg-config/gtk-4.0

xdg-settings set default-web-browser vivaldi-snapshot.desktop

gsettings set org.gnome.desktop.interface color-scheme "$COLOR_SCHEME"
gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME"
gsettings set org.gnome.desktop.interface icon-theme "$ICON_THEME"
gsettings set org.gnome.desktop.interface cursor-theme "$CURSOR_THEME"
gsettings set org.gnome.desktop.interface accent-color "$ACCENT_COLOR"

gsettings set org.gnome.desktop.interface font-name "$FONT_FAMILY 11"
gsettings set org.gnome.desktop.interface document-font-name "$FONT_FAMILY 11"
gsettings set org.gnome.desktop.interface monospace-font-name "$FONT_FAMILY_MONO 11"
gsettings set org.gnome.desktop.wm.preferences titlebar-font "$FONT_FAMILY 11"
gsettings set org.gnome.desktop.wm.preferences button-layout ':'

jq -c '.[]' "$ROOT/config/symlinks.json" | while read -r pair; do
    src=$(eval echo "$(echo "$pair" | jq -r '.[0]')")
    dest=$(echo "$pair" | jq -r '.[1]')
    symlink "$src" "$dest"
done
