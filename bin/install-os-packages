#!/usr/bin/env bash
set -euo pipefail

JSON_FILE="$HOME/.visualglitch91/config/os-packages.json"

command -v jq >/dev/null || {
    echo "jq is required"
    exit 1
}

jq -r '.copr[]' "$JSON_FILE" | while read -r repo; do
    if ! dnf copr list | grep -q -F "$repo"; then
        sudo dnf -y copr enable "$repo"
    fi
done

jq -r '.dnf[]' "$JSON_FILE" | xargs sudo dnf install -y

if command -v cargo >/dev/null; then
    jq -r '.cargo[]' "$JSON_FILE" | while read -r pkg; do
        cargo binstall --version >/dev/null 2>&1 || {
            command -v "$pkg" >/dev/null 2>&1 || cargo install "$pkg"
        }
    done
fi

if command -v flatpak >/dev/null; then
    jq -r '.flatpak[]' "$JSON_FILE" | xargs -I{} flatpak install flathub -y --noninteractive {}
fi

if command -v npm >/dev/null; then
    jq -r '.npm[]' "$JSON_FILE" | xargs npm install -g
fi
